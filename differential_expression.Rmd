---
#title: "Differential Expression"
#output: html_document
---

#Use this notebook to perform differential expression and all other post-DE
#analyses. 

# Load necessary libraries
library(DESeq2)
library(tidyverse)

# Read in the counts matrix
counts_matrix <- read.csv("/projectnb/bf528/students/neharao/project-1-template-NB-Rao/results/full_filtered_counts_matrix.csv")

# Remove the first column from counts_matrix
counts_matrix <- counts_matrix[, -1]

# Recreate the coldata data frame
coldata <- data.frame(
  sample = colnames(counts_matrix),
  timepoint = c(rep("AD", 2), rep("P0", 2), rep("P4", 2), rep("P7", 2)) 
)

# Create DESeqDataSet
dds <- DESeqDataSetFromMatrix(countData = counts_matrix,
                              colData = coldata,
                              design = ~ timepoint)

# Perform differential expression analysis
dds <- DESeq(dds)

# Extract results
results <- results(dds, contrast = c("timepoint", "P0", "AD"))

# Read in gene ID to gene name mapping
gene_mapping <- read.csv("/projectnb/bf528/students/neharao/project-1-template-NB-Rao/results/full_genemap.csv")

library(tibble)

# Convert row names to a column in gene_mapping
gene_mapping$gene_id <- rownames(gene_mapping)

# Perform the left join
results_with_names <- left_join(results_df, gene_mapping, by = "gene_id")

# Save results with gene names
write.csv(results_with_names, "/projectnb/bf528/students/neharao/project-1-template-NB-Rao/results/differential_expression_results.csv", row.names = FALSE)
